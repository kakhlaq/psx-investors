<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PSX Book Closures with Payouts</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .symbol { font-weight: bold; color: #0056b3; }
        .dividend { color: #28a745; font-weight: bold; }
        .right { color: #dc3545; font-weight: bold; }
        .note { background-color: #f8f9fa; padding: 15px; border-radius: 5px; }
        .last-updated { font-size: 0.9em; color: #6c757d; }
    </style>
</head>
<body>
    <div class="container py-4">
        <h1 class="mb-3">PSX Book Closures with Payouts</h1>
        
        <div class="note mb-4">
            <strong>Note:</strong> Current PSX rule for Ex Date is "BC - Z" which means that book closure start date minus 2 working days will become the Ex-date which further means that book closure start date minus 3 working days will become last date of spot.
            <div class="last-updated mt-2" id="lastUpdated"></div>
        </div>
        
        <button id="refreshBtn" class="btn btn-primary mb-3">
            <span class="spinner-border spinner-border-sm d-none" id="spinner"></span>
            Refresh Data
        </button>
        
        <div class="table-responsive">
            <table class="table table-striped table-hover" id="closuresTable">
                <thead class="table-dark">
                    <tr>
                        <th>Symbol</th>
                        <th>Company Name</th>
                        <th>Face Value</th>
                        <th>Last Close</th>
                        <th>BG From</th>
                        <th>BG To</th>
                        <th>Payout</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const tableBody = document.getElementById('tableBody');
            const refreshBtn = document.getElementById('refreshBtn');
            const spinner = document.getElementById('spinner');
            const lastUpdated = document.getElementById('lastUpdated');
            
            // Load data initially
            fetchData();
            
            // Refresh button click handler
            refreshBtn.addEventListener('click', fetchData);
            
            async function fetchData() {
                try {
                    spinner.classList.remove('d-none');
                    refreshBtn.disabled = true;
                    
                    const response = await fetch('http://localhost:3000/api/book-closures');
                    const { success, data, lastUpdated: updatedTime } = await response.json();
                    
                    if (success) {
                        renderTable(data);
                        const date = new Date(updatedTime);
                        lastUpdated.textContent = `Last updated: ${date.toLocaleString()}`;
                    }
                } catch (error) {
                    console.error('Error fetching data:', error);
                    alert('Failed to fetch data. Please try again later.');
                } finally {
                    spinner.classList.add('d-none');
                    refreshBtn.disabled = false;
                }
            }
            
            function renderTable(data) {
                tableBody.innerHTML = '';
                
                if (data.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="7" class="text-center">No data available</td></tr>';
                    return;
                }
                
                data.forEach(item => {
                    const row = document.createElement('tr');
                    const payoutType = item.payout.includes('Dividend') ? 'dividend' : 'right';
                    
                    row.innerHTML = `
                        <td class="symbol">${item.symbol}</td>
                        <td>${item.company}</td>
                        <td>${item.faceValue}</td>
                        <td>${item.lastClose}</td>
                        <td>${item.bgFrom}</td>
                        <td>${item.bgTo}</td>
                        <td class="${payoutType}">${item.payout}</td>
                    `;
                    tableBody.appendChild(row);
                });
            }
        });
    </script>
</body>
</html>
